// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  OWNER
  CAPTAIN
  BILLING
  HOTEL_MANAGER
}

model User {
  id               Int                @id @default(autoincrement())
  username         String             @unique
  email            String?            @unique
  password         String             // hashed password
  role             UserRole           @default(CAPTAIN)
  staffId          Int?               @unique // Link to StaffMember if applicable
  staff            StaffMember?       @relation(fields: [staffId], references: [id], onDelete: SetNull)
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@map("users")
}

model Table {
  id               Int                @id @default(autoincrement())
  capacity         Int
  status           TableStatus        @default(EMPTY)
  guests           Int?
  startTime        DateTime?
  isTakeaway       Boolean            @default(false)
  currentOrders    OrderItem[]
  transactions     Transaction[]

  @@map("tables")
}

model MenuItem {
  id               Int                @id @default(autoincrement())
  name             String
  category         String
  price            Float
  available        Boolean            @default(true)
  description      String?
  orderItems       OrderItem[]

  @@map("menu_items")
}

model OrderItem {
  id               Int                @id @default(autoincrement())
  tableId          Int
  table            Table              @relation(fields: [tableId], references: [id], onDelete: Cascade)
  menuId           Int
  menuItem         MenuItem           @relation(fields: [menuId], references: [id])
  name             String
  price            Float
  quantity         Int
  status           OrderStatus        @default(ORDERING)
  modifications    String?
  transactionId    String?
  transaction      Transaction?       @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Transaction {
  id               String             @id @default(cuid())
  tableId          Int
  table            Table              @relation(fields: [tableId], references: [id], onDelete: Cascade)
  isTakeaway       Boolean            @default(false)
  items            OrderItem[]
  totalAmount      Float
  timestamp        DateTime           @default(now())

  @@map("transactions")
}

model StaffMember {
  id               Int                @id @default(autoincrement())
  name             String
  role             String
  avatar           String
  user             User?              // Link to authentication User
  attendanceRecords AttendanceRecord[]

  @@map("staff_members")
}

model AttendanceRecord {
  id               Int                @id @default(autoincrement())
  staffId          Int
  staff            StaffMember        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  date             DateTime
  status           AttendanceStatus   @default(PRESENT)
  checkIn          DateTime?
  checkOut         DateTime?

  @@map("attendance_records")
}

enum TableStatus {
  EMPTY
  OCCUPIED
  NEEDS_SERVICE
  NEEDS_BILL
}

enum OrderStatus {
  ORDERING
  PREPARING
  READY
  SERVED
  VOID
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LEAVE
  LATE
}

// --- Room Management ---

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  CHECKOUT
}

enum RoomType {
  DELUXE
  PREMIUM_SUITE
  ROYAL_SUITE
}

enum BookingStatus {
  BOOKED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

enum RoomItemCategory {
  FOOD
  AMENITY
}

model Room {
  id             Int            @id @default(autoincrement())
  roomNumber     String         @unique
  type           RoomType       @default(DELUXE)
  floor          Int            @default(1)
  capacity       Int            @default(2)
  priceNonAC     Float          // Price per night without AC
  priceAC        Float          // Price per night with AC
  status         RoomStatus     @default(AVAILABLE)
  bookings       RoomBooking[]
  maintenanceLogs RoomMaintenanceLog[]

  @@map("rooms")
}

model RoomBooking {
  id                  Int              @id @default(autoincrement())
  roomId              Int
  room                Room             @relation(fields: [roomId], references: [id], onDelete: Cascade)
  guestName           String
  guestPhone          String
  adults              Int              @default(1)
  children            Int              @default(0)
  isAC                Boolean          @default(false)  // Guest chose AC or non-AC
  checkIn             DateTime         @default(now())
  checkOut            DateTime?
  totalAmount         Float            @default(0)
  pricePerNightMrp     Float?
  pricePerNightSelling Float?
  pricePerNightBill    Float?
  extraGuests          Int?             @default(0)
  extraBeddingIncluded Boolean?         @default(true)
  extraBeddingChargePerNight Float?
  status              BookingStatus    @default(CHECKED_IN)
  // Billing / GST fields
  invoiceNo           Int?             // User-entered invoice number
  gstEnabled          Boolean          @default(true)
  companyName         String?
  companyAddressLine1 String?
  companyAddressLine2 String?
  customerGstin       String?
  items               RoomServiceItem[]

  @@map("room_bookings")
}

model RoomServiceItem {
  id             Int              @id @default(autoincrement())
  bookingId      Int
  booking        RoomBooking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  name           String
  category       RoomItemCategory @default(AMENITY)
  price          Float
  quantity       Int              @default(1)
  timestamp      DateTime         @default(now())

  @@map("room_service_items")
}

// --- Room Maintenance ---

enum MaintenanceStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

model RoomMaintenanceLog {
  id             Int                @id @default(autoincrement())
  roomId         Int
  room           Room               @relation(fields: [roomId], references: [id], onDelete: Cascade)
  issue          String
  notes          String?
  status         MaintenanceStatus  @default(OPEN)
  reportedAt     DateTime           @default(now())
  resolvedAt     DateTime?

  @@map("room_maintenance_logs")
}
